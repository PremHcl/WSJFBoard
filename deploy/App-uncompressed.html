<!DOCTYPE html>
<html>
<head>
    <title>WSJFBoard</title>

    <script type="text/javascript" src="/apps/2.0/sdk.js"></script>

    <script type="text/javascript">
        Rally.onReady(function () {
                Ext.define('Rally.ui.bulk.RecordMenuFix', {
    override: 'Rally.ui.menu.bulk.RecordMenu',
    _getMenuItems: function() {
        var records = this.getRecords();
        var items = this.callParent(arguments);
        items.push({
             xtype: 'wsjfBulkSetRisk',
             id: 'wsjfBulkSetRisk'
         });
        items.push({
             xtype: 'wsjfBulkSetValue',
             id: 'wsjfBulkSetValue'
        });
        items.push({
             xtype: 'wsjfBulkSetTime',
             id: 'wsjfBulkSetTime'
        });

        _.each(items, function (item) {
            Ext.apply(item, {
                records: records,
                store: this.store,
                onBeforeAction: this.onBeforeAction,
                onActionComplete: this.onActionComplete,
                context: this.getContext()
            });
        }, this);

        return items;
     }
});


Ext.define('CustomApp', {
    extend: 'Rally.app.App',
    componentCls: 'app',

    launch: function() {

        var modelNames = ['portfolioitem/initiative'];
        var context = this.getContext();

        var grid = Ext.create('Rally.ui.grid.Grid', {
            id: 'piGrid',
            margin: 30,
//            stateful: false,
//            toggleState: 'grid',
//            plugins: [
//                {
//                    ptype: 'rallygridboardcustomfiltercontrol',
//                    filterControlConfig: {
//                        modelNames: modelNames,
//                        stateful: true,
//                        stateId: context.getScopedStateId('custom-filter-example')
//                    },
//                    showOwnerFilter: true,
//                    ownerFilterControlConfig: {
//                        stateful: true,
//                        stateId: context.getScopedStateId('owner-filter-example')
//                    }
//                }
//            ],
            columnCfgs: [
                'FormattedID',
                'Name',
                'Project',
                'RROEValue',
                'UserBusinessValue',
                'TimeCriticality',
                'JobSize',
                'WSJFScore'
            ],
            bulkEditConfig: {
                showEdit: false,
                showTag: false,
                showParent: false,
                showRemove: false
            },
            context: this.getContext(),
            enableBulkEdit: true,
            enableRanking: true,
            storeConfig: {
                batchAction: true,
                model: modelNames,
                sorters: {
                    property: 'wsjfScore',
                    direction: 'DESC'
                },
                fetch: ['FormattedID', 'Name', 'Project', 'JobSize', 'RROEValue', 'TimeCriticality', 'UserBusinessValue', 'WSJFScore', 'State'],
                filters: [
                    {
                        property: 'State.Name',
                        operator: '!=',
                        value: 'Done'
                    }
                ]
//                listeners: {
//                    load: function(arg1, arg2, arg3) { debugger; }
//                }
            },
            sortableColumns: false, //We will auto sort on WSJF number,
            listeners: {
                inlineeditsaved: function( grid, record, opts) {
                    var num = (record.get('RROEValue') + record.get('UserBusinessValue') + record.get('TimeCriticality'))/record.get('JobSize');

                    //if the field is 'decimal' you can only have two decimal places....
                    record.set('WSJFScore', num.toFixed(2));
                    record.save( {
                        callback: function() {
                            Ext.getCmp('piGrid').refresh();
                        }
                    });
                }
            }

        });

        //Ext.util.Observable.capture( grid, function(event) { console.log(event, arguments);});

        this.add(grid);

        var picard = Ext.create('Ext.Container', {
            id: 'MakeItSo',
            layout: {
                type: 'vbox',
                align: 'center'
            }
        });

        picard.add( {
                xtype: 'rallybutton',
                text: 'Commit',
                handler: this._storeRecords,
                scope: this
        });

        this.add(picard);
    },

    _recordToRank: 0,
    _rankingRecord: null,
    _store: null,

    _storeRecords: function() {

        this._store = Ext.getCmp('piGrid').store;
        this._recordToRank = 0;
        this._rankingRecord = this._store.data.items[this._recordToRank];

        this._rankingRecord.save( {
            rankTo: 'TOP',
            callback: function(arg1, arg2, arg3) {
                this._recordToRank += 1;
                this._saveNextRecord();
            },
            scope: this
        });
    },

    _saveNextRecord: function ()
    {
        if ( this._recordToRank < this._store.getCount()){
            var nextRecord = this._store.data.items[this._recordToRank];
            Rally.data.Ranker.rankRelative( {
                recordToRank: nextRecord,
                relativeRecord: this._rankingRecord,
                position: 'after',
                callback: function(arg1, arg2, arg3){
                    this._recordToRank += 1;
                    this._rankingRecord = arg1;
                    this._saveNextRecord();
                },
                scope: this
            });
        }
    }


//        _.each(store.data.items, function(item) {
//            var rankConfig = Rally.data.Ranker.generateRankParameters( { relativeRecord: rankingRecord, position: 'after' });
//            var rrConfig = {
//                    recordToRank: item,
//                    relativeRecord: rankingRecord,
//                    position: 'after'
//                };
//
//            Rally.data.Ranker.rankRelative(rrConfig);
//            rankingRecord = item;
//        });



});

Ext.define('dataModel', {
    extend: 'Ext.data.Model',
    fields: [
        {name: 'Name',  type: 'string'  },
        {name: 'Value', type: 'integer' }
    ]
});


Ext.define('wsjfBulkSetRisk', {
    extend:  Rally.ui.menu.bulk.MenuItem ,
    alias: 'widget.wsjfBulkSetRisk',

    config: {
        text: 'Risk',
        handler: function(arg1, arg2, arg3) {
            this._onSetRisk(arg1, arg2, arg3);
        }
    },

    _onSetRisk: function(arg1, arg2, arg3) {
        var data = {
            dataValues: [
                { 'Name':'None', 'Value': 1 },
                { 'Name':'Minimal', 'Value': 3 },
                { 'Name':'Low', 'Value': 5 },
                { 'Name':'Medium', 'Value': 8 },
                { 'Name':'High', 'Value': 13 },
                { 'Name':'Extreme', 'Value': 21 }
            ]
        };

        var store = Ext.create('Ext.data.Store', {
            autoLoad: true,
            model: 'dataModel',
            data: data,
            proxy: {
                type: 'memory',
                reader: {
                    type: 'json',
                    root: 'dataValues'
                }
            }
        });

        var riskBox = Ext.create( 'Ext.form.ComboBox', {
            id: 'riskBox',
            store: store,
            queryMode: 'local',
            displayField: 'Name',
            valueField: 'Value'
        });

        var doChooser = Ext.create( 'Rally.ui.dialog.Dialog', {
            id: 'riskChooser',
            autoShow: true,
            draggable: true,
            width: 300,
            records: this.records,
            title: 'Choose Risk setting',
            items: riskBox,
            buttons: [
                {   text: 'OK',
                    handler: function(arg1, arg2, arg3) {
                        _.each(this.records, function(record) {
                            record.set('RROEValue', Ext.getCmp('riskBox').value);
                            var num = (record.get('RROEValue') + record.get('UserBusinessValue') + record.get('TimeCriticality'))/record.get('JobSize');

                            //if the field is 'decimal' you can only have two decimal places....
                            record.set('WSJFScore', num.toFixed(2));
                            record.save( {
                                    callback: function() {
                                        Ext.getCmp('piGrid').refresh();
                                        Ext.getCmp('riskChooser').destroy();
                                    }
                            });
                        });
                    },
                    scope: this
                }
            ]
        });
    }
});

Ext.define('wsjfBulkSetValue', {
    extend:  Rally.ui.menu.bulk.MenuItem ,
    alias: 'widget.wsjfBulkSetValue',

    config: {
        text: 'Business Value',
        handler: function(arg1, arg2, arg3) {
            this._onSetValue(arg1, arg2, arg3);
        }
    },

    _onSetValue: function(arg1, arg2, arg3) {
        var data = {
            dataValues: [
                { 'Name':'None', 'Value': 1 },
                { 'Name':'Minimal', 'Value': 3 },
                { 'Name':'Low', 'Value': 5 },
                { 'Name':'Medium', 'Value': 8 },
                { 'Name':'High', 'Value': 13 },
                { 'Name':'Extreme', 'Value': 21 }
            ]
        };

        var store = Ext.create('Ext.data.Store', {
            autoLoad: true,
            model: 'dataModel',
            data: data,
            proxy: {
                type: 'memory',
                reader: {
                    type: 'json',
                    root: 'dataValues'
                }
            }
        });

        var valueBox = Ext.create( 'Ext.form.ComboBox', {
            id: 'valueBox',
            store: store,
            queryMode: 'local',
            displayField: 'Name',
            valueField: 'Value'
        });

        var doChooser = Ext.create( 'Rally.ui.dialog.Dialog', {
            id: 'valueChooser',
            autoShow: true,
            draggable: true,
            width: 300,
            records: this.records,
            title: 'Choose Business Value setting',
            items: valueBox,
            buttons: [
                {   text: 'OK',
                    handler: function(arg1, arg2, arg3) {
                        _.each(this.records, function(record) {
                            record.set('UserBusinessValue', Ext.getCmp('valueBox').value);
                            var num = (record.get('RROEValue') + record.get('UserBusinessValue') + record.get('TimeCriticality'))/record.get('JobSize');

                            //if the field is 'decimal' you can only have two decimal places....
                            record.set('WSJFScore', num.toFixed(2));
                            record.save( {
                                    callback: function() {
                                        Ext.getCmp('piGrid').refresh();
                                        Ext.getCmp('valueChooser').destroy();
                                    }
                            });
                        });
                    },
                    scope: this
                }
            ]
        });
    }
});

Ext.define('wsjfBulkSetTime', {
    extend:  Rally.ui.menu.bulk.MenuItem ,
    alias: 'widget.wsjfBulkSetTime',

    config: {
        text: 'Time Criticality',
        handler: function(arg1, arg2, arg3) {
            this._onSetTime(arg1, arg2, arg3);
        }
    },

    _onSetTime: function(arg1, arg2, arg3) {
        var data = {
            dataValues: [
                { 'Name':'None', 'Value': 1 },
                { 'Name':'Minimal', 'Value': 3 },
                { 'Name':'Low', 'Value': 5 },
                { 'Name':'Medium', 'Value': 8 },
                { 'Name':'High', 'Value': 13 },
                { 'Name':'Extreme', 'Value': 21 }
            ]
        };

        var store = Ext.create('Ext.data.Store', {
            autoLoad: true,
            model: 'dataModel',
            data: data,
            proxy: {
                type: 'memory',
                reader: {
                    type: 'json',
                    root: 'dataValues'
                }
            }
        });

        var timeBox = Ext.create( 'Ext.form.ComboBox', {
            id: 'timeBox',
            store: store,
            queryMode: 'local',
            displayField: 'Name',
            valueField: 'Value'
        });

        var doChooser = Ext.create( 'Rally.ui.dialog.Dialog', {
            id: 'timeChooser',
            autoShow: true,
            draggable: true,
            width: 300,
            records: this.records,
            title: 'Choose Time Criticality',
            items: timeBox,
            buttons: [
                {   text: 'OK',
                    handler: function(arg1, arg2, arg3) {
                        _.each(this.records, function(record) {
                            record.set('TimeCriticality', Ext.getCmp('timeBox').value);
                            var num = (record.get('RROEValue') + record.get('UserBusinessValue') + record.get('TimeCriticality'))/record.get('JobSize');

                            //if the field is 'decimal' you can only have two decimal places....
                            record.set('WSJFScore', num.toFixed(2));
                            record.save( {
                                    callback: function() {
                                        Ext.getCmp('piGrid').refresh();
                                        Ext.getCmp('timeChooser').destroy();
                                    }
                            });
                        });
                    },
                    scope: this
                }
            ]
        });
    }
});

                (function() {

    var Ext = window.Ext4 || window.Ext;

    /**
     * @private
     * A Rest Proxy for the Rally WSAPI Collection Endpoints
     * Extends Ext's default Rest proxy to work with our WSAPI way of doing things
     */
    Ext.define('Rally.data.wsapi.collection.Proxy', {
        extend: 'Rally.data.wsapi.Proxy',
        requires: ['Rally.data.wsapi.ProxyBase'],
        alias: ['proxy.Rally.data.WsapiCollectionProxy', 'proxy.rallywsapicollectionproxy'],
        alternateClassName: ['Rally.data.WsapiCollectionProxy'],

        mixins: {
            proxy: 'Rally.data.wsapi.ProxyBase'
        },

        urlMappings: {
            create:  'add',
            destroy: 'remove'
        },

        statics: {
            /**
             * Maximum number of artifacts that can be added/removed from a collection at a time
             * Defined by AbstractCollectionPostHandler
             */
            MAX_ARTIFACTS_PER_OPERATION: 25
        },

        constructor: function(){
            this.callParent(arguments);
        },

        /**
         * Override to add the requester for client-side metrics
         */
        buildRequest: function(operation) {
            var request = this.callParent(arguments);
            request.requester = this.requester;
            return request;
        },

        /**
         * Override to convert the URL to the correct format for WSAPI collection endpoints
         */
        buildUrl: function(request) {
            request.url = this.url;
            if(this.urlMappings[request.action]) {
                request.url += '/' + this.urlMappings[request.action];
            }
            return request.url;
        },

        /**
         * Returns the HTTP method name for a given request.
         * @param {Ext.data.Request} request The request object
         * @return {String} The HTTP method to use ('GET', 'POST', 'PUT' or 'DELETE')
         */
        getMethod: function (request) {
            if (request.action === 'read') {
                return 'GET';
            }
            return 'POST';
        },

        /**
         * Override to batch 25 artifacts per API action (create, update or delete),
         * the 25 limit is a requirement of the endpoint as implemented in AbstractCollectionPostHandler.MAX_ARTIFACTS
        */
        batch: function(options, /* deprecated */listeners) {
            var me = this,
                useBatch = me.batchActions,
                batch,
                records,
                actions, aLen, action, a;

            if (options.operations === undefined) {
                // the old-style (operations, listeners) signature was called
                // so convert to the single options argument syntax
                options = {
                    operations: options,
                    listeners: listeners
                };
            }

            if (options.batch) {
                if (Ext.isDefined(options.batch.runOperation)) {
                    batch = Ext.applyIf(options.batch, {
                        proxy: me,
                        listeners: {}
                    });
                }
            } else {
                options.batch = {
                    proxy: me,
                    listeners: options.listeners || {}
                };
            }

            if (!batch) {
                batch = new Ext.data.Batch(options.batch);
            }

            batch.on('complete', Ext.bind(me.onBatchComplete, me, [options], 0));

            actions = me.batchOrder.split(',');
            aLen = actions.length;

            var addBatch = function(record) {
                batch.add(new Ext.data.Operation({
                    action: action,
                    records: [record]
                }));
            };

            var addBatches = function(recordBatch){
                if (useBatch) {
                    batch.add(new Ext.data.Operation({
                        action: action,
                        records: recordBatch
                    }));
                } else {
                    _.each(recordBatch, addBatch);
                }
            };

            // For each action i.e. (create,update,destroy),
            for (a = 0; a < aLen; a++) {
                action = actions[a];
                records = options.operations[action];

                // Split the records into smaller batches
                var recordBatches = this._splitBatch(records);
                _.each(recordBatches, addBatches, recordBatches);
            }

            batch.start();
            return batch;
        },

        /**
         * Split the records into smaller batches so that
         * the max artifacts per operation limit is not exceeded.
         * @param [records]
         * @returns [[records], [records], [records]]
         * @private
         */
        _splitBatch: function(records) {
            var getBatchIndex = function(element, index) {
                return Math.floor(index / this.self.MAX_ARTIFACTS_PER_OPERATION);
            };
            return _.chain(records).groupBy(getBatchIndex, this).toArray().value();
        }
    });
})();

            Rally.launchApp('CustomApp', {
                name:"WSJFBoard",
	            parentRepos:""
            });

        });
    </script>


    <style type="text/css">
        .app {
  /* Add app styles here */
}

    </style>
</head>
<body>
</body>
</html>
